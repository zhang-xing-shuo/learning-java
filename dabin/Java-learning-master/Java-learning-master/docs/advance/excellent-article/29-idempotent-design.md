---
sidebar: heading
title: 接口的幂等性如何设计？
category: 优质文章
tag:
  - Spring Boot
head:
  - - meta
    - name: keywords
      content: 接口幂等,幂等性
  - - meta
    - name: description
      content: 努力打造最优质的Java学习网站
---

## 接口的幂等性如何设计？

分布式系统中的某个接口，该如何保证幂等性？

假如有个服务提供一个付款接口供外部调用，这个服务部署在了 5 台机器上。然后用户在前端上操作的时候，不小心发起了两次支付请求，然后这俩请求分散在了这个服务部署的不同的机器上，结果一个订单扣款扣两次。

这就是典型的接口幂等性问题。

所谓幂等性，就是说一个接口，多次发起同一个请求，你这个接口得保证结果是准确的，比如不能多扣款、不能多插入一条数据、不能将统计值多加了 1。这就是幂等性。

其实保证幂等性主要是三点：

对于每个请求必须有一个唯一的标识，举个例子：订单支付请求，肯定得包含订单 id，一个订单 id 最多支付一次。每次处理完请求之后，必须有一个记录标识这个请求处理过了。常见的方案是在数据库中记录一个状态，比如支付之前记录一条这个订单的支付流水。

每次接收请求需要进行判断，判断之前是否处理过。如果订单已经支付了，就已经有了一条支付流水，那么如果重复发送这个请求，则此时先插入支付流水，orderId 已经存在了，唯一键约束生效，报错插入不进去的。然后你就不用再扣款了。

实际运作过程中，你要结合自己的业务来，比如说利用 Redis，用 orderId 作为唯一键。只有成功插入这个支付流水，才可以执行实际的支付扣款。

要求是支付一个订单，必须插入一条支付流水，order_id 建一个唯一键 unique key 。你在支付一个订单之前，先插入一条支付流水，order_id 就已经进去了。你就可以写一个标识到 Redis 里面去， set order_id payed ，下一次重复请求过来了，先查 Redis 的 order_id 对应的 value，如果是 payed 就说明已经支付过了，就别重复支付了。
